<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#B8860B" id="themeColor">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Hoje na Palavra">
<meta name="description" content="Reflex√µes b√≠blicas di√°rias com intelig√™ncia artificial">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<title>Hoje na Palavra</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;0,900;1,400;1,700&family=Lora:ital,wght@0,400;0,500;0,600;1,400&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ============================================================
   CSS VARIABLES & RESET
   ============================================================ */
:root {
  --amber-50: #FFFBEB;
  --amber-100: #FEF3C7;
  --amber-200: #FDE68A;
  --amber-300: #FCD34D;
  --amber-400: #FBBF24;
  --amber-500: #F59E0B;
  --amber-600: #D97706;
  --amber-700: #B45309;
  --amber-800: #92400E;
  --amber-900: #78350F;

  --bg: #FAFAF7;
  --bg-card: #FFFFFF;
  --bg-subtle: #F5F0E8;
  --bg-panel: #FFFCF5;
  --text-primary: #1C1410;
  --text-secondary: #5C4A3A;
  --text-muted: #9C8070;
  --border: rgba(184,134,11,0.2);
  --border-strong: rgba(184,134,11,0.4);
  --gold: #B8860B;
  --gold-light: #D4A017;
  --gold-pale: #F7EDD0;
  --shadow: 0 2px 16px rgba(120,80,20,0.10);
  --shadow-lg: 0 8px 40px rgba(120,80,20,0.16);
  --radius: 16px;
  --radius-sm: 10px;
  --radius-pill: 999px;
  --font-display: 'Playfair Display', Georgia, serif;
  --font-body: 'Lora', Georgia, serif;
  --font-ui: 'Nunito', system-ui, sans-serif;
  --transition: 0.3s cubic-bezier(0.4,0,0.2,1);
  --nav-h: 64px;
}

[data-theme="dark"] {
  --bg: #0F0D09;
  --bg-card: #1A1610;
  --bg-subtle: #231E15;
  --bg-panel: #1E1A12;
  --text-primary: #F5EDD8;
  --text-secondary: #C4A87A;
  --text-muted: #806850;
  --border: rgba(212,160,23,0.15);
  --border-strong: rgba(212,160,23,0.3);
  --gold: #D4A017;
  --gold-light: #E8B830;
  --gold-pale: #2A2010;
  --shadow: 0 2px 16px rgba(0,0,0,0.4);
  --shadow-lg: 0 8px 40px rgba(0,0,0,0.5);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 16px; -webkit-tap-highlight-color: transparent; }
body {
  font-family: var(--font-ui);
  background: var(--bg);
  color: var(--text-primary);
  min-height: 100vh;
  max-width: 480px;
  margin: 0 auto;
  overflow-x: hidden;
  transition: background var(--transition), color var(--transition);
}

/* ============================================================
   HEADER
   ============================================================ */
.app-header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  padding: 0 16px;
  height: 56px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  box-shadow: var(--shadow);
}

.header-brand { display: flex; align-items: center; gap: 8px; }

.header-logo {
  width: 32px; height: 32px;
  background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%);
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px; color: white; font-weight: 700;
  font-family: var(--font-display); flex-shrink: 0;
}

.header-title {
  font-family: var(--font-display);
  font-size: 1.05rem; font-weight: 700;
  color: var(--text-primary); line-height: 1.1;
}

.header-title span {
  display: block; font-size: 0.6rem; font-weight: 400;
  font-style: italic; color: var(--text-muted);
  font-family: var(--font-body); letter-spacing: 0.5px;
}

.header-actions { display: flex; align-items: center; gap: 4px; }

.header-btn {
  background: none; border: none;
  width: 36px; height: 36px; border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; color: var(--text-secondary);
  font-size: 18px;
  transition: background var(--transition), color var(--transition), transform 0.15s;
}
.header-btn:hover { background: var(--gold-pale); color: var(--gold); }
.header-btn:active { transform: scale(0.9); }

/* User avatar button */
.user-avatar-btn {
  width: 32px; height: 32px; border-radius: 50%;
  background: linear-gradient(135deg, var(--gold), var(--gold-light));
  border: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  color: white; font-size: 13px; font-weight: 700;
  font-family: var(--font-ui);
  transition: transform 0.2s;
}
.user-avatar-btn:hover { transform: scale(1.08); }

/* ============================================================
   PAGES / SCREENS
   ============================================================ */
.page {
  display: none;
  min-height: calc(100vh - 56px - var(--nav-h));
  padding-bottom: calc(var(--nav-h) + 16px);
  animation: pageIn 0.35s cubic-bezier(0.4,0,0.2,1) forwards;
}
.page.active { display: block; }

@keyframes pageIn {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ============================================================
   HOME PAGE
   ============================================================ */
.date-nav {
  display: flex; align-items: center;
  justify-content: space-between;
  padding: 14px 16px 10px; gap: 12px;
}

.date-nav-btn {
  background: var(--bg-card); border: 1px solid var(--border);
  width: 40px; height: 40px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; color: var(--text-secondary); font-size: 18px;
  transition: all var(--transition); flex-shrink: 0;
}
.date-nav-btn:hover { border-color: var(--gold); color: var(--gold); background: var(--gold-pale); }
.date-nav-btn:active { transform: scale(0.9); }
.date-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }

.date-center { flex: 1; text-align: center; cursor: pointer; }
.date-label { font-family: var(--font-ui); font-size: 0.75rem; font-weight: 600; color: var(--gold); text-transform: uppercase; letter-spacing: 1px; }
.date-full { font-family: var(--font-display); font-size: 0.9rem; color: var(--text-secondary); font-style: italic; }

.devotional-card {
  margin: 0 12px 16px;
  background: var(--bg-card); border-radius: var(--radius);
  border: 1px solid var(--border); overflow: hidden;
  box-shadow: var(--shadow);
  animation: cardIn 0.5s cubic-bezier(0.4,0,0.2,1) forwards;
}

@keyframes cardIn {
  from { opacity: 0; transform: translateY(20px) scale(0.98); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.card-header {
  background: linear-gradient(135deg, var(--gold) 0%, #C8960A 60%, #E8B020 100%);
  padding: 20px; text-align: center; position: relative; overflow: hidden;
}

.card-header::before {
  content: '';
  position: absolute; inset: 0;
  background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 5L35 20H50L38.5 29L43 44L30 35L17 44L21.5 29L10 20H25z' fill='%23ffffff' fill-opacity='0.06'/%3E%3C/svg%3E") center/50px repeat;
  opacity: 0.5;
}

.card-ref { position: relative; font-family: var(--font-ui); font-size: 0.7rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: rgba(255,255,255,0.85); margin-bottom: 6px; }
.card-verse { position: relative; font-family: var(--font-display); font-size: 1.1rem; font-weight: 700; color: #fff; line-height: 1.4; text-shadow: 0 1px 4px rgba(0,0,0,0.2); padding: 0 8px; }
.card-verse::before, .card-verse::after { content: '"'; font-size: 2rem; color: rgba(255,255,255,0.3); font-family: var(--font-display); font-style: italic; line-height: 0; vertical-align: -0.4em; }

.card-body { padding: 18px 16px 8px; }

.section-divider { display: flex; align-items: center; gap: 10px; margin: 14px 0 12px; }
.section-divider::before, .section-divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }
.section-divider span { color: var(--gold); font-size: 14px; }

.points-grid { display: flex; flex-direction: column; gap: 10px; margin-bottom: 16px; }

.point-item {
  background: var(--bg-subtle); border-radius: var(--radius-sm);
  padding: 12px 14px; border-left: 3px solid var(--gold); transition: transform 0.2s;
}
.point-item:hover { transform: translateX(3px); }
.point-label { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--gold); margin-bottom: 4px; }
.point-text { font-family: var(--font-body); font-size: 0.88rem; color: var(--text-secondary); line-height: 1.5; }

.core-message {
  background: linear-gradient(135deg, var(--gold-pale), var(--bg-subtle));
  border: 1px solid var(--border-strong); border-radius: var(--radius-sm);
  padding: 14px 16px; text-align: center; margin-bottom: 14px;
}
.core-message p { font-family: var(--font-display); font-size: 0.92rem; font-style: italic; font-weight: 600; color: var(--gold); line-height: 1.4; }

.card-actions { display: flex; gap: 8px; padding: 0 16px 16px; }

.action-btn {
  flex: 1; height: 42px; border-radius: var(--radius-sm);
  border: 1px solid var(--border); background: var(--bg-card);
  color: var(--text-secondary); font-family: var(--font-ui);
  font-size: 0.8rem; font-weight: 600; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  gap: 6px; transition: all var(--transition);
}
.action-btn:hover { border-color: var(--gold); color: var(--gold); background: var(--gold-pale); }
.action-btn:active { transform: scale(0.96); }
.action-btn.active { background: var(--gold-pale); border-color: var(--gold); color: var(--gold); }
.action-btn.primary { background: var(--gold); border-color: var(--gold); color: white; }
.action-btn.primary:hover { background: var(--gold-light); }

.generate-section {
  margin: 0 12px 16px; background: var(--bg-card);
  border-radius: var(--radius); border: 1px solid var(--border);
  padding: 14px; box-shadow: var(--shadow);
}

.gen-row { display: flex; gap: 8px; align-items: center; }
.gen-input-wrap { position: relative; flex: 1; }
.gen-input {
  width: 100%; background: var(--bg-subtle); border: 1px solid var(--border);
  color: var(--text-primary); padding: 10px 40px 10px 12px;
  border-radius: var(--radius-sm); font-size: 0.88rem; font-family: var(--font-ui);
  outline: none; transition: border-color var(--transition);
}
.gen-input:focus { border-color: var(--gold); }
.gen-input::placeholder { color: var(--text-muted); }

.gen-ai-btn {
  position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
  background: none; border: none; color: var(--gold); cursor: pointer;
  font-size: 16px; padding: 4px; transition: transform 0.2s;
}
.gen-ai-btn:hover { transform: translateY(-50%) scale(1.2) rotate(20deg); }

.gen-btn {
  background: var(--gold); color: white; border: none;
  padding: 0 16px; height: 40px; border-radius: var(--radius-sm);
  font-family: var(--font-ui); font-size: 0.8rem; font-weight: 700;
  cursor: pointer; letter-spacing: 0.5px; transition: all var(--transition);
  white-space: nowrap;
}
.gen-btn:hover { background: var(--gold-light); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(184,134,11,0.3); }
.gen-btn:active { transform: translateY(0); }
.gen-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

/* ============================================================
   FAVORITES PAGE
   ============================================================ */
.page-header { padding: 16px 16px 8px; display: flex; align-items: center; justify-content: space-between; }
.page-title { font-family: var(--font-display); font-size: 1.4rem; font-weight: 700; color: var(--text-primary); }
.page-subtitle { font-size: 0.75rem; color: var(--text-muted); font-family: var(--font-body); font-style: italic; }

.fav-list { padding: 0 12px; display: flex; flex-direction: column; gap: 10px; }

.fav-item {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 14px; cursor: pointer;
  transition: all var(--transition); display: flex; gap: 12px; align-items: flex-start;
}
.fav-item:hover { border-color: var(--gold); box-shadow: var(--shadow); transform: translateY(-1px); }

.fav-item-accent { width: 3px; border-radius: 2px; background: var(--gold); flex-shrink: 0; align-self: stretch; min-height: 40px; }
.fav-item-content { flex: 1; min-width: 0; }
.fav-item-ref { font-size: 0.65rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: var(--gold); margin-bottom: 4px; }
.fav-item-verse { font-family: var(--font-body); font-size: 0.82rem; color: var(--text-secondary); line-height: 1.4; font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.fav-item-date { font-size: 0.65rem; color: var(--text-muted); margin-top: 4px; }
.fav-item-del { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 16px; padding: 4px; flex-shrink: 0; transition: color var(--transition); }
.fav-item-del:hover { color: #E53E3E; }

.empty-state { text-align: center; padding: 60px 24px; }
.empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
.empty-title { font-family: var(--font-display); font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 6px; }
.empty-desc { font-size: 0.82rem; color: var(--text-muted); font-family: var(--font-body); font-style: italic; line-height: 1.5; }

/* ============================================================
   SETTINGS PAGE
   ============================================================ */
.settings-section { padding: 8px 12px; }
.settings-section-title { font-size: 0.65rem; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; color: var(--gold); padding: 8px 4px 6px; }
.settings-list { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); overflow: hidden; }
.settings-item { display: flex; align-items: center; padding: 14px 14px; gap: 12px; border-bottom: 1px solid var(--border); transition: background var(--transition); cursor: pointer; }
.settings-item:last-child { border-bottom: none; }
.settings-item:hover { background: var(--gold-pale); }
.settings-item-icon { width: 34px; height: 34px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
.settings-item-icon.amber { background: rgba(184,134,11,0.15); }
.settings-item-icon.blue { background: rgba(59,130,246,0.12); }
.settings-item-icon.green { background: rgba(34,197,94,0.12); }
.settings-item-icon.purple { background: rgba(168,85,247,0.12); }
.settings-item-icon.red { background: rgba(239,68,68,0.12); }
.settings-item-content { flex: 1; min-width: 0; }
.settings-item-title { font-size: 0.9rem; font-weight: 600; color: var(--text-primary); }
.settings-item-desc { font-size: 0.73rem; color: var(--text-muted); margin-top: 1px; }
.settings-item-right { margin-left: auto; flex-shrink: 0; }

.toggle { position: relative; display: inline-flex; width: 44px; height: 24px; }
.toggle input { opacity: 0; width: 0; height: 0; }
.toggle-slider { position: absolute; cursor: pointer; inset: 0; background: var(--bg-subtle); border: 1.5px solid var(--border); border-radius: 12px; transition: all var(--transition); }
.toggle-slider::after { content: ''; position: absolute; width: 18px; height: 18px; border-radius: 50%; background: #fff; top: 1px; left: 1px; transition: transform var(--transition); box-shadow: 0 1px 4px rgba(0,0,0,0.2); }
.toggle input:checked + .toggle-slider { background: var(--gold); border-color: var(--gold); }
.toggle input:checked + .toggle-slider::after { transform: translateX(20px); }

.lang-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 12px; }
.lang-btn { background: var(--bg-subtle); border: 1.5px solid var(--border); border-radius: 8px; padding: 10px 6px; text-align: center; cursor: pointer; transition: all var(--transition); }
.lang-btn:hover { border-color: var(--gold); background: var(--gold-pale); }
.lang-btn.active { border-color: var(--gold); background: var(--gold-pale); }
.lang-flag { font-size: 20px; display: block; margin-bottom: 2px; }
.lang-name { font-size: 0.68rem; font-weight: 600; color: var(--text-secondary); }
.lang-btn.active .lang-name { color: var(--gold); }

.api-key-section { margin: 0 12px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 14px; }
.api-key-label { font-size: 0.72rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
.api-key-input-wrap { position: relative; }
.api-key-input { width: 100%; background: var(--bg-subtle); border: 1px solid var(--border); color: var(--text-primary); padding: 10px 36px 10px 12px; border-radius: 8px; font-size: 0.82rem; font-family: monospace; outline: none; transition: border-color var(--transition); }
.api-key-input:focus { border-color: var(--gold); }
.api-key-toggle { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 16px; }
.api-key-hint { font-size: 0.68rem; color: var(--text-muted); margin-top: 6px; line-height: 1.4; }
.api-key-hint a { color: var(--gold); text-decoration: none; }

.model-select { width: 100%; background: var(--bg-subtle); border: 1px solid var(--border); color: var(--text-primary); padding: 10px 12px; border-radius: 8px; font-size: 0.82rem; font-family: var(--font-ui); outline: none; transition: border-color var(--transition); cursor: pointer; -webkit-appearance: none; }
.model-select:focus { border-color: var(--gold); }

/* ============================================================
   BOTTOM NAVIGATION
   ============================================================ */
.bottom-nav {
  position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
  width: 100%; max-width: 480px; height: var(--nav-h);
  background: var(--bg-card); border-top: 1px solid var(--border);
  display: flex; align-items: center; z-index: 100;
  box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
  backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
}

.nav-btn {
  flex: 1; display: flex; flex-direction: column; align-items: center;
  justify-content: center; gap: 4px; height: 100%;
  background: none; border: none; cursor: pointer; color: var(--text-muted);
  transition: color var(--transition); position: relative; font-family: var(--font-ui);
}
.nav-btn:hover { color: var(--gold); }
.nav-btn.active { color: var(--gold); }
.nav-btn-icon { font-size: 20px; transition: transform 0.2s; }
.nav-btn.active .nav-btn-icon { transform: scale(1.15); }
.nav-btn:active .nav-btn-icon { transform: scale(0.9); }
.nav-btn-label { font-size: 0.62rem; font-weight: 600; letter-spacing: 0.3px; }
.nav-badge { position: absolute; top: 8px; right: calc(50% - 18px); background: var(--gold); color: white; border-radius: 99px; min-width: 16px; height: 16px; font-size: 0.6rem; font-weight: 700; display: flex; align-items: center; justify-content: center; padding: 0 4px; line-height: 1; }
.nav-btn.active::after { content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 32px; height: 2px; background: var(--gold); border-radius: 0 0 4px 4px; }

/* ============================================================
   LOADERS & OVERLAYS
   ============================================================ */
.loader-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 999; display: none; flex-direction: column; align-items: center; justify-content: center; gap: 14px; }
.loader-overlay.active { display: flex; }
.loader-spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.2); border-top-color: var(--gold); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.loader-text { color: white; font-family: var(--font-ui); font-size: 0.9rem; font-weight: 600; }

.toast-container { position: fixed; bottom: calc(var(--nav-h) + 12px); left: 50%; transform: translateX(-50%); z-index: 9999; width: calc(100% - 32px); max-width: 440px; pointer-events: none; display: flex; flex-direction: column; gap: 8px; }
.toast { background: var(--text-primary); color: var(--bg); border-radius: var(--radius-sm); padding: 12px 16px; font-size: 0.85rem; font-family: var(--font-ui); font-weight: 500; box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 10px; animation: toastIn 0.3s ease forwards; pointer-events: auto; }
.toast.success { background: #166534; color: #dcfce7; }
.toast.error { background: #991b1b; color: #fee2e2; }
.toast.info { background: var(--text-primary); }
@keyframes toastIn { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
@keyframes toastOut { from { opacity: 1; transform: translateY(0) scale(1); } to { opacity: 0; transform: translateY(10px) scale(0.9); } }

.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(6px); z-index: 800; display: none; align-items: flex-end; justify-content: center; }
.modal-overlay.active { display: flex; }
.modal-sheet { background: var(--bg-card); border-radius: 20px 20px 0 0; width: 100%; max-width: 480px; max-height: 80vh; overflow-y: auto; animation: sheetUp 0.35s cubic-bezier(0.4,0,0.2,1) forwards; }
@keyframes sheetUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.modal-handle { width: 36px; height: 4px; background: var(--border); border-radius: 2px; margin: 12px auto 0; }
.modal-title { font-family: var(--font-display); font-size: 1.1rem; font-weight: 700; padding: 14px 18px 8px; color: var(--text-primary); border-bottom: 1px solid var(--border); }
.modal-body { padding: 14px 18px 20px; }

.share-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; padding: 8px 0; }
.share-item { display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; transition: transform 0.2s; }
.share-item:hover { transform: scale(1.08); }
.share-item:active { transform: scale(0.95); }
.share-icon { width: 50px; height: 50px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
.share-label { font-size: 0.68rem; font-weight: 600; color: var(--text-secondary); text-align: center; }

/* ============================================================
   AUTH MODAL
   ============================================================ */
.auth-modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.75); backdrop-filter: blur(8px);
  z-index: 900; display: none;
  align-items: center; justify-content: center;
}
.auth-modal-overlay.active { display: flex; }

.auth-modal {
  background: var(--bg-card); border-radius: var(--radius);
  width: calc(100% - 32px); max-width: 400px;
  padding: 28px 24px; box-shadow: var(--shadow-lg);
  animation: authIn 0.3s cubic-bezier(0.4,0,0.2,1) forwards;
}
@keyframes authIn { from { opacity: 0; transform: scale(0.92) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }

.auth-logo {
  width: 52px; height: 52px; margin: 0 auto 16px;
  background: linear-gradient(135deg, var(--gold), var(--gold-light));
  border-radius: 14px; display: flex; align-items: center;
  justify-content: center; font-size: 24px; color: white;
}

.auth-title { font-family: var(--font-display); font-size: 1.3rem; font-weight: 700; color: var(--text-primary); text-align: center; margin-bottom: 6px; }
.auth-subtitle { font-size: 0.82rem; color: var(--text-muted); text-align: center; margin-bottom: 22px; font-family: var(--font-body); font-style: italic; }

.auth-tabs { display: flex; gap: 0; background: var(--bg-subtle); border-radius: 8px; padding: 3px; margin-bottom: 20px; }
.auth-tab { flex: 1; padding: 8px; border: none; background: none; border-radius: 6px; font-family: var(--font-ui); font-size: 0.82rem; font-weight: 600; color: var(--text-muted); cursor: pointer; transition: all var(--transition); }
.auth-tab.active { background: var(--bg-card); color: var(--gold); box-shadow: var(--shadow); }

.auth-field { margin-bottom: 14px; }
.auth-label { display: block; font-size: 0.72rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.auth-input { width: 100%; background: var(--bg-subtle); border: 1.5px solid var(--border); color: var(--text-primary); padding: 11px 14px; border-radius: 8px; font-size: 0.9rem; font-family: var(--font-ui); outline: none; transition: border-color var(--transition); }
.auth-input:focus { border-color: var(--gold); }

.auth-btn {
  width: 100%; height: 46px; background: var(--gold); color: white;
  border: none; border-radius: 10px; font-family: var(--font-ui);
  font-size: 0.95rem; font-weight: 700; cursor: pointer;
  margin-top: 6px; transition: all var(--transition);
  display: flex; align-items: center; justify-content: center; gap: 8px;
}
.auth-btn:hover { background: var(--gold-light); transform: translateY(-1px); }
.auth-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

.auth-divider { display: flex; align-items: center; gap: 10px; margin: 16px 0; }
.auth-divider::before, .auth-divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }
.auth-divider span { font-size: 0.72rem; color: var(--text-muted); }

.auth-close { position: absolute; top: 12px; right: 12px; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 20px; padding: 8px; }

.auth-error { background: rgba(153,27,27,0.1); border: 1px solid rgba(153,27,27,0.3); color: #dc2626; border-radius: 8px; padding: 10px 12px; font-size: 0.8rem; margin-bottom: 12px; display: none; }
.auth-error.show { display: block; }

/* User panel */
.user-panel {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius-sm); margin: 0 12px 16px;
  padding: 16px; display: none;
}
.user-panel.show { display: block; }
.user-panel-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
.user-panel-avatar { width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, var(--gold), var(--gold-light)); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; font-weight: 700; font-family: var(--font-ui); }
.user-panel-name { font-weight: 700; font-size: 0.95rem; color: var(--text-primary); }
.user-panel-email { font-size: 0.72rem; color: var(--text-muted); }
.user-panel-stats { display: flex; gap: 0; border-top: 1px solid var(--border); padding-top: 12px; }
.user-stat { flex: 1; text-align: center; }
.user-stat-num { font-family: var(--font-display); font-size: 1.3rem; font-weight: 700; color: var(--gold); }
.user-stat-label { font-size: 0.65rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.user-stat + .user-stat { border-left: 1px solid var(--border); }

.logout-btn { width: 100%; margin-top: 12px; padding: 10px; border-radius: 8px; border: 1.5px solid var(--border); background: none; color: var(--text-secondary); font-family: var(--font-ui); font-size: 0.82rem; font-weight: 600; cursor: pointer; transition: all var(--transition); }
.logout-btn:hover { border-color: #dc2626; color: #dc2626; background: rgba(220,38,38,0.05); }

/* Cloud sync indicator */
.sync-indicator {
  display: inline-flex; align-items: center; gap: 4px;
  font-size: 0.65rem; color: var(--text-muted);
  padding: 3px 8px; background: var(--bg-subtle);
  border-radius: 99px; margin-top: 8px;
}
.sync-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--text-muted); }
.sync-dot.synced { background: #22c55e; }
.sync-dot.syncing { background: var(--gold); animation: pulse 1s infinite; }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

/* ============================================================
   MISC
   ============================================================ */
.divider { height: 1px; background: var(--border); margin: 4px 12px; }
.badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 99px; font-size: 0.65rem; font-weight: 700; background: var(--gold-pale); color: var(--gold); border: 1px solid var(--border-strong); }
.app-version { text-align: center; padding: 24px 0 8px; font-size: 0.7rem; color: var(--text-muted); font-family: var(--font-body); font-style: italic; }

.install-banner { margin: 0 12px 12px; background: linear-gradient(135deg, var(--gold-pale), var(--bg-card)); border: 1px solid var(--border-strong); border-radius: var(--radius-sm); padding: 12px 14px; display: flex; align-items: center; gap: 12px; display: none; }
.install-banner.show { display: flex; }
.install-banner-text { flex: 1; }
.install-banner-text strong { font-size: 0.82rem; color: var(--text-primary); display: block; }
.install-banner-text span { font-size: 0.72rem; color: var(--text-muted); }
.install-btn { background: var(--gold); color: white; border: none; border-radius: 8px; padding: 8px 14px; font-size: 0.78rem; font-weight: 700; cursor: pointer; white-space: nowrap; font-family: var(--font-ui); }

::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; }
}

.skeleton { background: linear-gradient(90deg, var(--bg-subtle) 25%, var(--border) 50%, var(--bg-subtle) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 6px; color: transparent; user-select: none; }
@keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
</style>
</head>

<body>

<!-- APP HEADER -->
<header class="app-header">
  <div class="header-brand">
    <div class="header-logo">‚ú¶</div>
    <div class="header-title">
      Hoje na Palavra
      <span>Reflex√µes Di√°rias</span>
    </div>
  </div>
  <div class="header-actions">
    <button class="header-btn" id="themeToggleBtn" title="Alternar tema" aria-label="Alternar tema claro/escuro">üåô</button>
    <button class="header-btn" id="notifBtn" title="Notifica√ß√µes" aria-label="Configurar notifica√ß√µes">üîî</button>
    <!-- Auth Button -->
    <button class="header-btn" id="authHeaderBtn" title="Entrar / Minha conta">üë§</button>
  </div>
</header>

<!-- INSTALL BANNER -->
<div class="install-banner" id="installBanner">
  <span style="font-size:24px">üì≤</span>
  <div class="install-banner-text">
    <strong>Instalar no seu dispositivo</strong>
    <span>Acesse offline, receba notifica√ß√µes</span>
  </div>
  <button class="install-btn" id="installAppBtn">Instalar</button>
  <button class="header-btn" id="dismissBannerBtn" style="width:28px;height:28px;font-size:14px">‚úï</button>
</div>

<!-- HOME PAGE -->
<section class="page active" id="page-home">
  <div class="date-nav">
    <button class="date-nav-btn" id="prevDayBtn" aria-label="Dia anterior">‚Äπ</button>
    <div class="date-center" id="dateCenterBtn">
      <div class="date-label" id="dateLabelEl">Hoje</div>
      <div class="date-full" id="dateFullEl">27 de fevereiro de 2026</div>
    </div>
    <button class="date-nav-btn" id="nextDayBtn" aria-label="Pr√≥ximo dia" disabled>‚Ä∫</button>
  </div>

  <div class="generate-section">
    <div class="gen-row">
      <div class="gen-input-wrap">
        <input type="text" class="gen-input" id="topicInput" placeholder="Tema para o devocional..." value="Confian√ßa em Deus">
        <button class="gen-ai-btn" id="aiSuggestBtn" title="Sugerir tema com IA">‚ú®</button>
      </div>
      <button class="gen-btn" id="generateBtn">CRIAR</button>
    </div>
  </div>

  <div class="devotional-card" id="devotionalCard">
    <div class="card-header" id="cardHeader">
      <div class="card-ref" id="refDisplay">PROV√âRBIOS 3:5</div>
      <div class="card-verse" id="verseDisplay">Confia no Senhor de todo o teu cora√ß√£o e n√£o te estribes no teu pr√≥prio entendimento</div>
    </div>
    <div class="card-body">
      <div class="section-divider"><span>‚ú¶</span></div>
      <div class="points-grid">
        <div class="point-item">
          <div class="point-label" id="label1">üïä Vida Espiritual</div>
          <div class="point-text" id="appGod">Confiar implica entregar o controle, mesmo quando n√£o h√° explica√ß√µes vis√≠veis.</div>
        </div>
        <div class="point-item">
          <div class="point-label" id="label2">üåø Vida Pessoal</div>
          <div class="point-text" id="appJob">Decis√µes baseadas apenas na l√≥gica humana podem ser limitadas pela f√©.</div>
        </div>
        <div class="point-item">
          <div class="point-label" id="label3">‚úù F√© Di√°ria</div>
          <div class="point-text" id="appFamily">Antes de reagir a qualquer situa√ß√£o hoje, ore primeiro e responda depois.</div>
        </div>
      </div>
      <div class="core-message">
        <p id="coreDisplay">"Confian√ßa madura n√£o depende de certezas, depende de entrega."</p>
      </div>
    </div>
    <div class="card-actions">
      <button class="action-btn" id="favBtn">ü§ç Salvar</button>
      <button class="action-btn" id="shareBtn">‚Üó Partilhar</button>
      <button class="action-btn primary" id="downloadBtn">üíæ Baixar</button>
    </div>
  </div>
</section>

<!-- FAVORITES PAGE -->
<section class="page" id="page-favorites">
  <div class="page-header">
    <div>
      <div class="page-title" id="favPageTitle">Favoritos</div>
      <div class="page-subtitle" id="favPageSubtitle">Suas reflex√µes salvas</div>
    </div>
  </div>
  <div class="fav-list" id="favList">
    <div class="empty-state">
      <div class="empty-icon">ü§ç</div>
      <div class="empty-title" id="emptyFavTitle">Nenhum favorito ainda</div>
      <div class="empty-desc" id="emptyFavDesc">Toque em "Salvar" em qualquer devocional para adicion√°-lo aqui</div>
    </div>
  </div>
</section>

<!-- SETTINGS PAGE -->
<section class="page" id="page-settings">
  <div class="page-header">
    <div>
      <div class="page-title" id="settingsTitle">Configura√ß√µes</div>
      <div class="page-subtitle" id="settingsSubtitle">Personalize sua experi√™ncia</div>
    </div>
  </div>

  <!-- User Panel (shown when logged in) -->
  <div id="userPanel" class="user-panel" style="display:none;">
    <div class="user-panel-header">
      <div class="user-panel-avatar" id="userPanelAvatar">üë§</div>
      <div>
        <div class="user-panel-name" id="userPanelName">Usu√°rio</div>
        <div class="user-panel-email" id="userPanelEmail"></div>
      </div>
    </div>
    <div class="user-panel-stats">
      <div class="user-stat">
        <div class="user-stat-num" id="statFavCount">0</div>
        <div class="user-stat-label">Favoritos</div>
      </div>
      <div class="user-stat">
        <div class="user-stat-num" id="statHistCount">0</div>
        <div class="user-stat-label">Gerados</div>
      </div>
    </div>
    <button class="logout-btn" id="logoutBtn">üö™ Sair da conta</button>
  </div>

  <!-- Language -->
  <div class="settings-section">
    <div class="settings-section-title" id="settingLangTitle">Idioma</div>
    <div class="settings-list" style="overflow:visible;">
      <div class="lang-grid" id="langGrid">
        <div class="lang-btn active" data-lang="pt-BR"><span class="lang-flag">üáßüá∑</span><span class="lang-name">Portugu√™s</span></div>
        <div class="lang-btn" data-lang="en"><span class="lang-flag">üá∫üá∏</span><span class="lang-name">English</span></div>
        <div class="lang-btn" data-lang="es"><span class="lang-flag">üá™üá∏</span><span class="lang-name">Espa√±ol</span></div>
        <div class="lang-btn" data-lang="fr"><span class="lang-flag">üá´üá∑</span><span class="lang-name">Fran√ßais</span></div>
        <div class="lang-btn" data-lang="de"><span class="lang-flag">üá©üá™</span><span class="lang-name">Deutsch</span></div>
        <div class="lang-btn" data-lang="it"><span class="lang-flag">üáÆüáπ</span><span class="lang-name">Italiano</span></div>
      </div>
    </div>
  </div>

  <!-- AI Config -->
  <div class="settings-section">
    <div class="settings-section-title" id="settingAITitle">Intelig√™ncia Artificial</div>
    <div class="api-key-section">
      <div class="api-key-label">üîë Chave da API Google (Gemini)</div>
      <div class="api-key-input-wrap">
        <input type="password" class="api-key-input" id="apiKeyInput" placeholder="AIza...">
        <button class="api-key-toggle" id="apiKeyToggle">üëÅ</button>
      </div>
      <p class="api-key-hint">API gratuita do Google Gemini. Obtenha em <a href="https://aistudio.google.com/apikey" target="_blank">aistudio.google.com/apikey</a></p>
      <div style="margin-top:10px;">
        <div class="api-key-label">ü§ñ Modelo de IA</div>
        <select class="model-select" id="modelSelect">
          <option value="gemini-2.0-flash">Gemini 2.0 Flash (R√°pido ¬∑ Gratuito ‚≠ê)</option>
          <option value="gemini-2.0-flash-thinking-exp">Gemini 2.0 Thinking (Experimental)</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Notifications -->
  <div class="settings-section">
    <div class="settings-section-title" id="settingNotifTitle">Notifica√ß√µes</div>
    <div class="settings-list">
      <div class="settings-item">
        <div class="settings-item-icon green">üîî</div>
        <div class="settings-item-content">
          <div class="settings-item-title" id="notifDailyLabel">Devocional di√°rio (8h)</div>
          <div class="settings-item-desc" id="notifDailyDesc">Receba reflex√£o todo dia de manh√£</div>
        </div>
        <div class="settings-item-right"><label class="toggle"><input type="checkbox" id="notifToggle"><span class="toggle-slider"></span></label></div>
      </div>
    </div>
  </div>

  <!-- Appearance -->
  <div class="settings-section">
    <div class="settings-section-title" id="settingAppearTitle">Apar√™ncia</div>
    <div class="settings-list">
      <div class="settings-item">
        <div class="settings-item-icon amber">üåô</div>
        <div class="settings-item-content">
          <div class="settings-item-title" id="darkModeLabel">Modo escuro</div>
          <div class="settings-item-desc" id="darkModeDesc">Interface escura para ambientes com pouca luz</div>
        </div>
        <div class="settings-item-right"><label class="toggle"><input type="checkbox" id="darkModeToggle"><span class="toggle-slider"></span></label></div>
      </div>
    </div>
  </div>

  <!-- Links -->
  <div class="settings-section">
    <div class="settings-section-title" id="settingLinksTitle">Links</div>
    <div class="settings-list">
      <div class="settings-item" id="openWebAppBtn">
        <div class="settings-item-icon blue">üåê</div>
        <div class="settings-item-content">
          <div class="settings-item-title" id="webAppLabel">Abrir App Web</div>
          <div class="settings-item-desc">hoje-na-palavra.github.io</div>
        </div>
        <div class="settings-item-right" style="color:var(--text-muted);font-size:18px">‚Ä∫</div>
      </div>
      <div class="settings-item" id="clearDataBtn">
        <div class="settings-item-icon red">üóë</div>
        <div class="settings-item-content">
          <div class="settings-item-title" id="clearDataLabel">Limpar dados</div>
          <div class="settings-item-desc" id="clearDataDesc">Remove favoritos e configura√ß√µes</div>
        </div>
        <div class="settings-item-right" style="color:var(--text-muted);font-size:18px">‚Ä∫</div>
      </div>
    </div>
  </div>

  <div class="app-version" id="appVersion">Hoje na Palavra v2.0.0 ¬∑ Feito com ‚ù§Ô∏è</div>
</section>

<!-- BOTTOM NAVIGATION -->
<nav class="bottom-nav">
  <button class="nav-btn active" id="nav-home" data-page="home">
    <span class="nav-btn-icon">üè†</span>
    <span class="nav-btn-label" data-i18n="nav_home">In√≠cio</span>
  </button>
  <button class="nav-btn" id="nav-favorites" data-page="favorites">
    <span class="nav-btn-icon">ü§ç</span>
    <span class="nav-btn-label" data-i18n="nav_favorites">Favoritos</span>
    <span class="nav-badge" id="favBadge" style="display:none">0</span>
  </button>
  <button class="nav-btn" id="nav-settings" data-page="settings">
    <span class="nav-btn-icon">‚öôÔ∏è</span>
    <span class="nav-btn-label" data-i18n="nav_settings">Config.</span>
  </button>
</nav>

<!-- LOADER -->
<div class="loader-overlay" id="loaderOverlay">
  <div class="loader-spinner"></div>
  <div class="loader-text" id="loaderText">Gerando com IA...</div>
</div>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toastContainer"></div>

<!-- SHARE MODAL -->
<div class="modal-overlay" id="shareModal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title" id="shareModalTitle">Partilhar Devocional</div>
    <div class="modal-body">
      <div class="share-grid">
        <div class="share-item" id="shareWhatsApp"><div class="share-icon" style="background:#25D366;color:white">üí¨</div><span class="share-label">WhatsApp</span></div>
        <div class="share-item" id="shareTelegram"><div class="share-icon" style="background:#2CA5E0;color:white">‚úàÔ∏è</div><span class="share-label">Telegram</span></div>
        <div class="share-item" id="shareTwitter"><div class="share-icon" style="background:#000;color:white">‚úï</div><span class="share-label">X / Twitter</span></div>
        <div class="share-item" id="shareFacebook"><div class="share-icon" style="background:#1877F2;color:white">f</div><span class="share-label">Facebook</span></div>
        <div class="share-item" id="shareInstagram"><div class="share-icon" style="background:linear-gradient(45deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888);color:white">üì∏</div><span class="share-label">Instagram</span></div>
        <div class="share-item" id="shareCopy"><div class="share-icon" style="background:var(--bg-subtle);color:var(--text-primary)">üìã</div><span class="share-label" id="shareCopyLabel">Copiar</span></div>
        <div class="share-item" id="shareNative"><div class="share-icon" style="background:var(--gold-pale);color:var(--gold)">‚ÜóÔ∏è</div><span class="share-label" id="shareNativeLabel">Mais...</span></div>
        <div class="share-item" id="shareModalClose"><div class="share-icon" style="background:var(--bg-subtle);color:var(--text-muted)">‚úï</div><span class="share-label" id="shareCancelLabel">Fechar</span></div>
      </div>
    </div>
  </div>
</div>

<!-- AUTH MODAL -->
<div class="auth-modal-overlay" id="authModal">
  <div class="auth-modal" style="position:relative;">
    <button class="auth-close" id="authModalClose">‚úï</button>
    <div class="auth-logo">‚ú¶</div>
    <div class="auth-title">Hoje na Palavra</div>
    <div class="auth-subtitle">Entre para sincronizar seus favoritos e hist√≥rico em todos os dispositivos</div>

    <div class="auth-tabs">
      <button class="auth-tab active" id="tabLogin">Entrar</button>
      <button class="auth-tab" id="tabRegister">Criar conta</button>
    </div>

    <div id="authError" class="auth-error"></div>

    <!-- Login Form -->
    <div id="loginForm">
      <div class="auth-field">
        <label class="auth-label">üìß E-mail</label>
        <input type="email" class="auth-input" id="loginEmail" placeholder="seu@email.com" autocomplete="email">
      </div>
      <div class="auth-field">
        <label class="auth-label">üîí Senha</label>
        <input type="password" class="auth-input" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
      </div>
      <button class="auth-btn" id="loginBtn">‚ú¶ Entrar</button>
    </div>

    <!-- Register Form -->
    <div id="registerForm" style="display:none;">
      <div class="auth-field">
        <label class="auth-label">üë§ Nome</label>
        <input type="text" class="auth-input" id="regName" placeholder="Seu nome">
      </div>
      <div class="auth-field">
        <label class="auth-label">üìß E-mail</label>
        <input type="email" class="auth-input" id="regEmail" placeholder="seu@email.com" autocomplete="email">
      </div>
      <div class="auth-field">
        <label class="auth-label">üîí Senha</label>
        <input type="password" class="auth-input" id="regPassword" placeholder="M√≠nimo 6 caracteres" autocomplete="new-password">
      </div>
      <button class="auth-btn" id="registerBtn">‚ú¶ Criar minha conta</button>
    </div>

    <div class="auth-divider"><span>Seus dados ficam salvos com seguran√ßa</span></div>
    <p style="text-align:center;font-size:0.72rem;color:var(--text-muted);">üîí Dados protegidos pelo Supabase</p>
  </div>
</div>

<!-- SCRIPTS -->
<script>
/* ============================================================
   SUPABASE CONFIG
   ============================================================ */
const SUPABASE_URL = 'https://anbbwhxilzpwxilhpwva.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFuYmJ3aHhpbHpwd3hpbGhwd3ZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyMTQ2ODQsImV4cCI6MjA4Nzc5MDY4NH0.mBP1OxNtAZjvXNxWYaEORWkpCXJzlZpFvlAe2VWJwa0'; // ‚Üê Substitua pela sua chave anon/public

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ============================================================
   I18N
   ============================================================ */
const i18n = {
  "pt-BR": {
    nav_home: "In√≠cio", nav_favorites: "Favoritos", nav_settings: "Config.",
    today: "Hoje", yesterday: "Ontem", tomorrow: "Amanh√£",
    generating: "Gerando com IA...", suggest_topic: "Sugerindo tema...",
    saved: "Salvo nos favoritos!", unsaved: "Removido dos favoritos",
    copied: "Copiado!", error_gen: "Erro ao gerar. Tente novamente.",
    error_key: "Configure sua chave de API em Configura√ß√µes",
    share_text: "üìñ Reflex√£o B√≠blica\n\n{ref}\n\"{verse}\"\n\n‚ú¶ {core}\n\nüôè Via Hoje na Palavra",
    create_btn: "CRIAR", topic_placeholder: "Tema para o devocional...",
    ai_suggest_title: "Sugerir tema com IA",
    points_labels: ["üïä Vida Espiritual", "üåø Vida Pessoal", "‚úù F√© Di√°ria"],
    fav_title: "Favoritos", fav_subtitle: "Suas reflex√µes salvas",
    empty_fav_title: "Nenhum favorito ainda",
    empty_fav_desc: 'Toque em "Salvar" em qualquer devocional para adicion√°-lo aqui',
    settings_title: "Configura√ß√µes", settings_subtitle: "Personalize sua experi√™ncia",
    section_lang: "Idioma", section_ai: "Intelig√™ncia Artificial",
    section_notif: "Notifica√ß√µes", section_appear: "Apar√™ncia", section_links: "Links",
    notif_daily: "Devocional di√°rio (8h)", notif_daily_desc: "Receba reflex√£o todo dia de manh√£",
    dark_mode: "Modo escuro", dark_mode_desc: "Interface escura para ambientes com pouca luz",
    web_app: "Abrir App Web", clear_data: "Limpar dados", clear_data_desc: "Remove favoritos e configura√ß√µes",
    share_title: "Partilhar Devocional", share_cancel: "Fechar", share_copy: "Copiar", share_more: "Mais...",
    save_btn: "ü§ç Salvar", saved_btn: "üíõ Salvo", share_btn: "‚Üó Partilhar", download_btn: "üíæ Baixar",
    install_title: "Instalar no seu dispositivo", install_desc: "Acesse offline, receba notifica√ß√µes",
    install_btn: "Instalar", notif_enabled: "Notifica√ß√µes ativadas!", notif_disabled: "Notifica√ß√µes desativadas",
    notif_denied: "Permiss√£o de notifica√ß√£o negada",
    clear_confirm: "Isso remover√° todos os favoritos e configura√ß√µes. Deseja continuar?",
    clear_done: "Dados limpos!",
    prompt_system: "Voc√™ √© um pastor/te√≥logo crist√£o especializado em devocionais b√≠blicos em portugu√™s do Brasil.",
    prompt_suggest: "Sugira um tema crist√£o inspirador em portugu√™s (1 a 4 palavras). Responda APENAS com o texto do tema, sem pontua√ß√£o.",
    prompt_devotional: `Escreva um devocional crist√£o em portugu√™s (Brasil) sobre: "{topic}".
Responda SOMENTE com JSON v√°lido neste formato:
{
  "ref": "LIVRO CAP:VERS",
  "verse": "vers√≠culo b√≠blico relacionado (max 20 palavras)",
  "app_god": "reflex√£o sobre vida espiritual (max 15 palavras)",
  "app_job": "aplica√ß√£o na vida pessoal/trabalho (max 15 palavras)",
  "app_family": "aplica√ß√£o na f√© di√°ria/fam√≠lia (max 15 palavras)",
  "core": "mensagem central impactante (max 12 palavras)"
}`,
  },
  "en": {
    nav_home: "Home", nav_favorites: "Favorites", nav_settings: "Settings",
    today: "Today", yesterday: "Yesterday", tomorrow: "Tomorrow",
    generating: "Generating with AI...", suggest_topic: "Suggesting topic...",
    saved: "Added to favorites!", unsaved: "Removed from favorites",
    copied: "Copied!", error_gen: "Error generating. Please try again.",
    error_key: "Please configure your API key in Settings",
    share_text: "üìñ Daily Devotional\n\n{ref}\n\"{verse}\"\n\n‚ú¶ {core}\n\nüôè Via Hoje na Palavra",
    create_btn: "CREATE", topic_placeholder: "Devotional topic...",
    ai_suggest_title: "Suggest topic with AI",
    points_labels: ["üïä Spiritual Life", "üåø Personal Life", "‚úù Daily Faith"],
    fav_title: "Favorites", fav_subtitle: "Your saved reflections",
    empty_fav_title: "No favorites yet",
    empty_fav_desc: 'Tap "Save" on any devotional to add it here',
    settings_title: "Settings", settings_subtitle: "Customize your experience",
    section_lang: "Language", section_ai: "Artificial Intelligence",
    section_notif: "Notifications", section_appear: "Appearance", section_links: "Links",
    notif_daily: "Daily devotional (8am)", notif_daily_desc: "Receive a reflection every morning",
    dark_mode: "Dark mode", dark_mode_desc: "Dark interface for low-light environments",
    web_app: "Open Web App", clear_data: "Clear data", clear_data_desc: "Remove favorites and settings",
    share_title: "Share Devotional", share_cancel: "Close", share_copy: "Copy", share_more: "More...",
    save_btn: "ü§ç Save", saved_btn: "üíõ Saved", share_btn: "‚Üó Share", download_btn: "üíæ Download",
    install_title: "Install on your device", install_desc: "Offline access, receive notifications",
    install_btn: "Install", notif_enabled: "Notifications enabled!", notif_disabled: "Notifications disabled",
    notif_denied: "Notification permission denied",
    clear_confirm: "This will remove all favorites and settings. Continue?",
    clear_done: "Data cleared!",
    prompt_system: "You are a Christian pastor/theologian specializing in biblical devotionals.",
    prompt_suggest: "Suggest a short inspiring Christian topic in English (1 to 4 words). Respond ONLY with the topic text, no punctuation.",
    prompt_devotional: `Write a Christian devotional in English about: "{topic}".
Respond ONLY with valid JSON:
{
  "ref": "BOOK CHAP:VERSE",
  "verse": "related Bible verse (max 20 words)",
  "app_god": "reflection on spiritual life (max 15 words)",
  "app_job": "application to personal/work life (max 15 words)",
  "app_family": "application to daily faith/family (max 15 words)",
  "core": "impactful core message (max 12 words)"
}`,
  },
  "es": {
    nav_home: "Inicio", nav_favorites: "Favoritos", nav_settings: "Config.",
    today: "Hoy", yesterday: "Ayer", tomorrow: "Ma√±ana",
    generating: "Generando con IA...", suggest_topic: "Sugiriendo tema...",
    saved: "¬°Guardado en favoritos!", unsaved: "Eliminado de favoritos",
    copied: "¬°Copiado!", error_gen: "Error al generar. Int√©ntalo de nuevo.",
    error_key: "Configura tu clave API en Configuraci√≥n",
    share_text: "üìñ Devocional B√≠blico\n\n{ref}\n\"{verse}\"\n\n‚ú¶ {core}\n\nüôè Via Hoje na Palavra",
    create_btn: "CREAR", topic_placeholder: "Tema para el devocional...",
    ai_suggest_title: "Sugerir tema con IA",
    points_labels: ["üïä Vida Espiritual", "üåø Vida Personal", "‚úù Fe Diaria"],
    fav_title: "Favoritos", fav_subtitle: "Tus reflexiones guardadas",
    empty_fav_title: "Sin favoritos a√∫n",
    empty_fav_desc: 'Toca "Guardar" en cualquier devocional para a√±adirlo aqu√≠',
    settings_title: "Configuraci√≥n", settings_subtitle: "Personaliza tu experiencia",
    section_lang: "Idioma", section_ai: "Inteligencia Artificial",
    section_notif: "Notificaciones", section_appear: "Apariencia", section_links: "Links",
    notif_daily: "Devocional diario (8h)", notif_daily_desc: "Recibe reflexi√≥n cada ma√±ana",
    dark_mode: "Modo oscuro", dark_mode_desc: "Interfaz oscura para entornos con poca luz",
    web_app: "Abrir App Web", clear_data: "Limpiar datos", clear_data_desc: "Elimina favoritos y configuraci√≥n",
    share_title: "Compartir Devocional", share_cancel: "Cerrar", share_copy: "Copiar", share_more: "M√°s...",
    save_btn: "ü§ç Guardar", saved_btn: "üíõ Guardado", share_btn: "‚Üó Compartir", download_btn: "üíæ Descargar",
    install_title: "Instalar en tu dispositivo", install_desc: "Acceso sin conexi√≥n, recibe notificaciones",
    install_btn: "Instalar", notif_enabled: "¬°Notificaciones activadas!", notif_disabled: "Notificaciones desactivadas",
    notif_denied: "Permiso de notificaci√≥n denegado",
    clear_confirm: "Esto eliminar√° todos los favoritos y configuraciones. ¬øContinuar?",
    clear_done: "¬°Datos eliminados!",
    prompt_system: "Eres un pastor/te√≥logo cristiano especializado en devocionales b√≠blicos en espa√±ol.",
    prompt_suggest: "Sugiere un tema cristiano inspirador en espa√±ol (1 a 4 palabras). Responde SOLO con el texto del tema.",
    prompt_devotional: `Escribe un devocional cristiano en espa√±ol sobre: "{topic}".
Responde SOLO con JSON v√°lido:
{
  "ref": "LIBRO CAP:VERS",
  "verse": "vers√≠culo b√≠blico relacionado (m√°x 20 palabras)",
  "app_god": "reflexi√≥n sobre vida espiritual (m√°x 15 palabras)",
  "app_job": "aplicaci√≥n a la vida personal/trabajo (m√°x 15 palabras)",
  "app_family": "aplicaci√≥n a la fe diaria/familia (m√°x 15 palabras)",
  "core": "mensaje central impactante (m√°x 12 palabras)"
}`,
  },
  "fr": {
    nav_home: "Accueil", nav_favorites: "Favoris", nav_settings: "Param√®tres",
    today: "Aujourd'hui", yesterday: "Hier", tomorrow: "Demain",
    generating: "G√©n√©ration IA...", suggest_topic: "Suggestion de th√®me...",
    saved: "Ajout√© aux favoris!", unsaved: "Retir√© des favoris",
    copied: "Copi√©!", error_gen: "Erreur. R√©essayez.",
    error_key: "Configurez votre cl√© API dans Param√®tres",
    share_text: "üìñ M√©ditation Biblique\n\n{ref}\n\"{verse}\"\n\n‚ú¶ {core}\n\nüôè Via Hoje na Palavra",
    create_btn: "CR√âER", topic_placeholder: "Th√®me du d√©votionnel...",
    ai_suggest_title: "Sugg√©rer th√®me avec IA",
    points_labels: ["üïä Vie Spirituelle", "üåø Vie Personnelle", "‚úù Foi Quotidienne"],
    fav_title: "Favoris", fav_subtitle: "Vos r√©flexions sauvegard√©es",
    empty_fav_title: "Aucun favori", empty_fav_desc: 'Appuyez sur "Sauvegarder" pour ajouter',
    settings_title: "Param√®tres", settings_subtitle: "Personnalisez votre exp√©rience",
    section_lang: "Langue", section_ai: "Intelligence Artificielle",
    section_notif: "Notifications", section_appear: "Apparence", section_links: "Liens",
    notif_daily: "D√©votionnel quotidien (8h)", notif_daily_desc: "Recevez une r√©flexion chaque matin",
    dark_mode: "Mode sombre", dark_mode_desc: "Interface sombre pour les environnements sombres",
    web_app: "Ouvrir App Web", clear_data: "Effacer donn√©es", clear_data_desc: "Supprimer favoris et param√®tres",
    share_title: "Partager", share_cancel: "Fermer", share_copy: "Copier", share_more: "Plus...",
    save_btn: "ü§ç Sauver", saved_btn: "üíõ Sauv√©", share_btn: "‚Üó Partager", download_btn: "üíæ T√©l√©charger",
    install_title: "Installer sur votre appareil", install_desc: "Acc√®s hors ligne, recevez des notifications",
    install_btn: "Installer", notif_enabled: "Notifications activ√©es!", notif_disabled: "Notifications d√©sactiv√©es",
    notif_denied: "Permission de notification refus√©e",
    clear_confirm: "Cela supprimera tous les favoris et param√®tres. Continuer?",
    clear_done: "Donn√©es effac√©es!",
    prompt_system: "Vous √™tes un pasteur/th√©ologien chr√©tien sp√©cialis√© dans les m√©ditations bibliques en fran√ßais.",
    prompt_suggest: "Sugg√©rez un th√®me chr√©tien inspirant en fran√ßais (1 √† 4 mots). R√©pondez UNIQUEMENT avec le texte du th√®me.",
    prompt_devotional: `√âcrivez une m√©ditation chr√©tienne en fran√ßais sur: "{topic}".
R√©pondez UNIQUEMENT avec un JSON valide:
{
  "ref": "LIVRE CHAP:VERS",
  "verse": "verset biblique (max 20 mots)",
  "app_god": "r√©flexion sur la vie spirituelle (max 15 mots)",
  "app_job": "application √† la vie personnelle (max 15 mots)",
  "app_family": "application √† la foi quotidienne (max 15 mots)",
  "core": "message central percutant (max 12 mots)"
}`,
  },
  "de": {
    nav_home: "Start", nav_favorites: "Favoriten", nav_settings: "Einstellungen",
    today: "Heute", yesterday: "Gestern", tomorrow: "Morgen",
    generating: "KI generiert...", suggest_topic: "Thema vorschlagen...",
    saved: "Zu Favoriten hinzugef√ºgt!", unsaved: "Aus Favoriten entfernt",
    copied: "Kopiert!", error_gen: "Fehler. Bitte versuchen Sie es erneut.",
    error_key: "Konfigurieren Sie Ihren API-Schl√ºssel in Einstellungen",
    share_text: "üìñ Bibelbetrachtung\n\n{ref}\n\"{verse}\"\n\n‚ú¶ {core}\n\nüôè Via Hoje na Palavra",
    create_btn: "ERSTELLEN", topic_placeholder: "Andachtsthema...",
    ai_suggest_title: "Thema mit KI vorschlagen",
    points_labels: ["üïä Geistliches Leben", "üåø Pers√∂nliches Leben", "‚úù T√§glicher Glaube"],
    fav_title: "Favoriten", fav_subtitle: "Ihre gespeicherten Andachten",
    empty_fav_title: "Noch keine Favoriten", empty_fav_desc: 'Tippen Sie auf "Speichern" um hinzuzuf√ºgen',
    settings_title: "Einstellungen", settings_subtitle: "Passen Sie Ihr Erlebnis an",
    section_lang: "Sprache", section_ai: "K√ºnstliche Intelligenz",
    section_notif: "Benachrichtigungen", section_appear: "Erscheinungsbild", section_links: "Links",
    notif_daily: "T√§gliche Andacht (8 Uhr)", notif_daily_desc: "Erhalten Sie jeden Morgen eine Betrachtung",
    dark_mode: "Dunkelmodus", dark_mode_desc: "Dunkle Oberfl√§che f√ºr wenig Licht",
    web_app: "Web App √∂ffnen", clear_data: "Daten l√∂schen", clear_data_desc: "Favoriten und Einstellungen entfernen",
    share_title: "Andacht teilen", share_cancel: "Schlie√üen", share_copy: "Kopieren", share_more: "Mehr...",
    save_btn: "ü§ç Speichern", saved_btn: "üíõ Gespeichert", share_btn: "‚Üó Teilen", download_btn: "üíæ Herunterladen",
    install_title: "Auf Ger√§t installieren", install_desc: "Offline-Zugang, Benachrichtigungen erhalten",
    install_btn: "Installieren", notif_enabled: "Benachrichtigungen aktiviert!", notif_disabled: "Benachrichtigungen deaktiviert",
    notif_denied: "Benachrichtigungsberechtigung verweigert",
    clear_confirm: "Dadurch werden alle Favoriten und Einstellungen entfernt. Fortfahren?",
    clear_done: "Daten gel√∂scht!",
    prompt_system: "Sie sind ein christlicher Pastor/Theologe, spezialisiert auf biblische Andachten auf Deutsch.",
    prompt_suggest: "Schlagen Sie ein inspirierendes christliches Thema auf Deutsch vor (1 bis 4 W√∂rter). Antworten Sie NUR mit dem Thementext.",
    prompt_devotional: `Schreiben Sie eine christliche Andacht auf Deutsch √ºber: "{topic}".
Antworten Sie NUR mit g√ºltigem JSON:
{
  "ref": "BUCH KAP:VERS",
  "verse": "verwandter Bibelvers (max 20 W√∂rter)",
  "app_god": "Betrachtung zum geistlichen Leben (max 15 W√∂rter)",
  "app_job": "Anwendung auf Berufs-/Privatleben (max 15 W√∂rter)",
  "app_family": "Anwendung auf t√§glichen Glauben (max 15 W√∂rter)",
  "core": "eindrucksvolle Kernbotschaft (max 12 W√∂rter)"
}`,
  },
  "it": {
    nav_home: "Home", nav_favorites: "Preferiti", nav_settings: "Impostazioni",
    today: "Oggi", yesterday: "Ieri", tomorrow: "Domani",
    generating: "Generazione IA...", suggest_topic: "Suggerimento tema...",
    saved: "Aggiunto ai preferiti!", unsaved: "Rimosso dai preferiti",
    copied: "Copiato!", error_gen: "Errore. Riprova.",
    error_key: "Configura la tua chiave API nelle Impostazioni",
    share_text: "üìñ Riflessione Biblica\n\n{ref}\n\"{verse}\"\n\n‚ú¶ {core}\n\nüôè Via Hoje na Palavra",
    create_btn: "CREA", topic_placeholder: "Tema del devozionale...",
    ai_suggest_title: "Suggerisci tema con IA",
    points_labels: ["üïä Vita Spirituale", "üåø Vita Personale", "‚úù Fede Quotidiana"],
    fav_title: "Preferiti", fav_subtitle: "Le tue riflessioni salvate",
    empty_fav_title: "Nessun preferito", empty_fav_desc: 'Tocca "Salva" su qualsiasi devozionale',
    settings_title: "Impostazioni", settings_subtitle: "Personalizza la tua esperienza",
    section_lang: "Lingua", section_ai: "Intelligenza Artificiale",
    section_notif: "Notifiche", section_appear: "Aspetto", section_links: "Link",
    notif_daily: "Devozionale giornaliero (8h)", notif_daily_desc: "Ricevi una riflessione ogni mattina",
    dark_mode: "Modalit√† scura", dark_mode_desc: "Interfaccia scura per ambienti bui",
    web_app: "Apri App Web", clear_data: "Cancella dati", clear_data_desc: "Rimuovi preferiti e impostazioni",
    share_title: "Condividi Devozionale", share_cancel: "Chiudi", share_copy: "Copia", share_more: "Altro...",
    save_btn: "ü§ç Salva", saved_btn: "üíõ Salvato", share_btn: "‚Üó Condividi", download_btn: "üíæ Scarica",
    install_title: "Installa sul dispositivo", install_desc: "Accesso offline, ricevi notifiche",
    install_btn: "Installa", notif_enabled: "Notifiche attivate!", notif_disabled: "Notifiche disattivate",
    notif_denied: "Autorizzazione notifica negata",
    clear_confirm: "Ci√≤ rimuover√† tutti i preferiti e le impostazioni. Continuare?",
    clear_done: "Dati cancellati!",
    prompt_system: "Sei un pastore/teologo cristiano specializzato in devozionali biblici in italiano.",
    prompt_suggest: "Suggerisci un tema cristiano ispirato in italiano (1 a 4 parole). Rispondi SOLO con il testo del tema.",
    prompt_devotional: `Scrivi un devozionale cristiano in italiano su: "{topic}".
Rispondi SOLO con JSON valido:
{
  "ref": "LIBRO CAP:VERS",
  "verse": "versetto biblico correlato (max 20 parole)",
  "app_god": "riflessione sulla vita spirituale (max 15 parole)",
  "app_job": "applicazione alla vita personale (max 15 parole)",
  "app_family": "applicazione alla fede quotidiana (max 15 parole)",
  "core": "messaggio centrale incisivo (max 12 parole)"
}`,
  }
};

/* ============================================================
   APP STATE
   ============================================================ */
const state = {
  lang: 'pt-BR',
  darkMode: false,
  apiKey: '',
  model: 'gemini-2.0-flash',
  currentDate: new Date(),
  today: new Date(),
  favorites: [],
  devotionals: {},
  currentDevotional: null,
  notifEnabled: false,
  deferredInstall: null,
  user: null,       // Supabase user
  syncEnabled: false,
};

const t = (key) => (i18n[state.lang] || i18n['pt-BR'])[key] || key;
const dateKey = (d) => d.toISOString().split('T')[0];
const sameDay = (a, b) => dateKey(a) === dateKey(b);

/* ============================================================
   STORAGE (localStorage)
   ============================================================ */
const DB = {
  save() {
    try {
      localStorage.setItem('hnp_lang', state.lang);
      localStorage.setItem('hnp_dark', state.darkMode ? '1' : '0');
      localStorage.setItem('hnp_key', state.apiKey);
      localStorage.setItem('hnp_model', state.model);
      localStorage.setItem('hnp_favs', JSON.stringify(state.favorites));
      localStorage.setItem('hnp_devs', JSON.stringify(state.devotionals));
      localStorage.setItem('hnp_notif', state.notifEnabled ? '1' : '0');
    } catch(e) { console.warn('Storage error', e); }
  },
  load() {
    try {
      state.lang = localStorage.getItem('hnp_lang') || 'pt-BR';
      state.darkMode = localStorage.getItem('hnp_dark') === '1';
      state.apiKey = localStorage.getItem('hnp_key') || '';
      state.model = localStorage.getItem('hnp_model') || 'gemini-2.0-flash';
      state.favorites = JSON.parse(localStorage.getItem('hnp_favs') || '[]');
      state.devotionals = JSON.parse(localStorage.getItem('hnp_devs') || '{}');
      state.notifEnabled = localStorage.getItem('hnp_notif') === '1';
    } catch(e) { console.warn('Storage load error', e); }
  },
  clear() {
    try {
      localStorage.removeItem('hnp_favs');
      localStorage.removeItem('hnp_devs');
      localStorage.removeItem('hnp_notif');
      state.favorites = [];
      state.devotionals = {};
      state.notifEnabled = false;
    } catch(e) {}
  }
};

/* ============================================================
   SUPABASE AUTH
   ============================================================ */
async function initSupabaseAuth() {
  const { data: { session } } = await sb.auth.getSession();
  if (session?.user) {
    await onUserLoggedIn(session.user);
  }

  sb.auth.onAuthStateChange(async (event, session) => {
    if (event === 'SIGNED_IN' && session?.user) {
      await onUserLoggedIn(session.user);
    } else if (event === 'SIGNED_OUT') {
      onUserLoggedOut();
    }
  });
}

async function onUserLoggedIn(user) {
  state.user = user;
  state.syncEnabled = true;
  updateAuthUI(user);
  await syncFromCloud();
  showToast('‚òÅÔ∏è Conta conectada!', 'success');
}

function onUserLoggedOut() {
  state.user = null;
  state.syncEnabled = false;
  updateAuthUI(null);
}

function updateAuthUI(user) {
  const btn = document.getElementById('authHeaderBtn');
  const panel = document.getElementById('userPanel');

  if (user) {
    const name = user.user_metadata?.name || user.email.split('@')[0];
    const initial = name.charAt(0).toUpperCase();
    btn.innerHTML = `<div class="user-avatar-btn">${initial}</div>`;
    btn.title = name;

    document.getElementById('userPanelAvatar').textContent = initial;
    document.getElementById('userPanelName').textContent = name;
    document.getElementById('userPanelEmail').textContent = user.email;
    panel.style.display = 'block';
    updateUserStats();
  } else {
    btn.textContent = 'üë§';
    btn.title = 'Entrar / Criar conta';
    panel.style.display = 'none';
  }
}

function updateUserStats() {
  document.getElementById('statFavCount').textContent = state.favorites.length;
  document.getElementById('statHistCount').textContent = Object.keys(state.devotionals).length;
}

async function doLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  if (!email || !password) return showAuthError('Preencha e-mail e senha.');

  const btn = document.getElementById('loginBtn');
  btn.disabled = true; btn.textContent = '‚è≥ Entrando...';

  const { error } = await sb.auth.signInWithPassword({ email, password });
  btn.disabled = false; btn.textContent = '‚ú¶ Entrar';

  if (error) {
    showAuthError(error.message === 'Invalid login credentials'
      ? 'E-mail ou senha incorretos.' : error.message);
  } else {
    closeAuthModal();
  }
}

async function doRegister() {
  const name = document.getElementById('regName').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  const password = document.getElementById('regPassword').value;

  if (!name || !email || !password) return showAuthError('Preencha todos os campos.');
  if (password.length < 6) return showAuthError('Senha deve ter pelo menos 6 caracteres.');

  const btn = document.getElementById('registerBtn');
  btn.disabled = true; btn.textContent = '‚è≥ Criando conta...';

  const { data, error } = await sb.auth.signUp({
    email, password,
    options: { data: { name } }
  });

  btn.disabled = false; btn.textContent = '‚ú¶ Criar minha conta';

  if (error) {
    showAuthError(error.message);
  } else {
    // Create profile in DB
    if (data.user) {
      await sb.from('perfis').upsert({
        id: data.user.id,
        nome: name,
        email: email
      });
    }
    closeAuthModal();
    showToast('üéâ Conta criada! Verifique seu e-mail.', 'success');
  }
}

async function doLogout() {
  await sb.auth.signOut();
  showToast('üëã At√© logo!', 'info');
}

function showAuthError(msg) {
  const el = document.getElementById('authError');
  el.textContent = msg;
  el.classList.add('show');
}

function clearAuthError() {
  document.getElementById('authError').classList.remove('show');
}

function openAuthModal() {
  document.getElementById('authModal').classList.add('active');
  clearAuthError();
}

function closeAuthModal() {
  document.getElementById('authModal').classList.remove('active');
}

/* ============================================================
   SUPABASE SYNC
   ============================================================ */
async function syncFromCloud() {
  if (!state.user) return;

  try {
    // Sync favorites
    const { data: favs } = await sb
      .from('favoritos')
      .select('*')
      .eq('usuario_id', state.user.id)
      .order('criado_em', { ascending: false });

    if (favs && favs.length > 0) {
      // Merge cloud favorites with local
      const cloudFavs = favs.map(f => ({
        id: f.id,
        ref: f.versiculo_referencia || '',
        verse: f.versiculo_texto || '',
        topic: f.tema || '',
        core: f.reflexao || '',
        date: f.criado_em?.split('T')[0] || dateKey(new Date()),
      }));

      // Merge: add cloud items not in local
      const localIds = new Set(state.favorites.map(f => String(f.id)));
      cloudFavs.forEach(cf => {
        if (!localIds.has(String(cf.id))) state.favorites.push(cf);
      });
      DB.save();
    }

    // Sync history
    const { data: hist } = await sb
      .from('historico')
      .select('*')
      .eq('usuario_id', state.user.id)
      .order('criado_em', { ascending: false })
      .limit(30);

    if (hist && hist.length > 0) {
      hist.forEach(h => {
        const dk = h.criado_em?.split('T')[0] || dateKey(new Date());
        if (!state.devotionals[dk]) {
          state.devotionals[dk] = {
            ref: h.versiculo_referencia,
            verse: h.versiculo_texto,
            app_god: h.reflexao_espiritual,
            app_job: h.reflexao_pessoal,
            app_family: h.reflexao_fe,
            core: h.frase,
            topic: h.tema,
            date: dk,
            id: h.id,
          };
        }
      });
      DB.save();
    }

    updateFavBadge();
    updateUserStats();
  } catch(e) {
    console.warn('Sync error:', e);
  }
}

async function saveToCloud(dev) {
  if (!state.user || !dev) return;
  try {
    await sb.from('historico').insert({
      usuario_id: state.user.id,
      tema: dev.topic,
      versiculo_referencia: dev.ref,
      versiculo_texto: dev.verse,
      reflexao_espiritual: dev.app_god,
      reflexao_pessoal: dev.app_job,
      reflexao_fe: dev.app_family,
      frase: dev.core,
    });
  } catch(e) { console.warn('Save history error:', e); }
}

async function saveFavToCloud(dev) {
  if (!state.user || !dev) return;
  try {
    const { data } = await sb.from('favoritos').insert({
      usuario_id: state.user.id,
      tema: dev.topic,
      versiculo_referencia: dev.ref,
      versiculo_texto: dev.verse,
      reflexao: dev.core,
    }).select().single();
    return data?.id;
  } catch(e) { console.warn('Save fav error:', e); }
}

async function removeFavFromCloud(cloudId) {
  if (!state.user || !cloudId) return;
  try {
    await sb.from('favoritos').delete().eq('id', cloudId).eq('usuario_id', state.user.id);
  } catch(e) { console.warn('Remove fav error:', e); }
}

/* ============================================================
   TOAST
   ============================================================ */
function showToast(msg, type = 'info', duration = 2800) {
  const container = document.getElementById('toastContainer');
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `<span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span> ${msg}`;
  container.appendChild(el);
  setTimeout(() => {
    el.style.animation = 'toastOut 0.3s ease forwards';
    setTimeout(() => el.remove(), 300);
  }, duration);
}

/* ============================================================
   LOADER
   ============================================================ */
function showLoader(text = '') {
  const el = document.getElementById('loaderOverlay');
  document.getElementById('loaderText').textContent = text || t('generating');
  el.classList.add('active');
}
function hideLoader() {
  document.getElementById('loaderOverlay').classList.remove('active');
}

/* ============================================================
   AI GENERATION
   ============================================================ */
const GEMINI_API_KEY = 'AIzaSyCABYBLIhEx5Jh5-IA2NIfZCW10K0k_G1Q';

async function callAI(systemPrompt, userPrompt, json = false) {
  const key = (state.apiKey && state.apiKey.trim()) || GEMINI_API_KEY;
  const model = state.model || 'gemini-2.0-flash';
  const jsonInstruction = json ? '\n\nIMPORTANT: Respond with ONLY a raw JSON object. No markdown, no backticks, no explanation.' : '';
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;

  let res;
  try {
    res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        system_instruction: { parts: [{ text: systemPrompt }] },
        contents: [{ parts: [{ text: userPrompt + jsonInstruction }] }],
        generationConfig: { temperature: 0.85, maxOutputTokens: 700, ...(json ? { responseMimeType: 'application/json' } : {}) }
      })
    });
  } catch(netErr) { throw new Error('Erro de rede. Verifique sua conex√£o.'); }

  let data;
  try { data = await res.json(); } catch { throw new Error(`HTTP ${res.status}`); }

  if (!res.ok) {
    const msg = data?.error?.message || `HTTP ${res.status}`;
    if (res.status === 400) throw new Error('Chave inv√°lida ou modelo incorreto.');
    if (res.status === 403) throw new Error('Chave sem permiss√£o. Verifique no Google AI Studio.');
    if (res.status === 429) throw new Error('Limite atingido. Aguarde um momento e tente novamente.');
    throw new Error(msg);
  }

  const content = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
  if (!content) throw new Error('Resposta vazia. Tente novamente.');
  return content;
}

async function suggestTopic() {
  showLoader(t('suggest_topic'));
  const aiBtn = document.getElementById('aiSuggestBtn');
  aiBtn.disabled = true;
  try {
    const result = await callAI(t('prompt_system'), t('prompt_suggest'));
    document.getElementById('topicInput').value = result.trim().replace(/['".,]/g, '');
  } catch(e) {
    showToast('‚ùå ' + e.message, 'error');
  } finally {
    hideLoader();
    aiBtn.disabled = false;
  }
}

async function generateDevotional(topic) {
  showLoader(t('generating'));
  document.getElementById('generateBtn').disabled = true;
  const prompt = t('prompt_devotional').replace('{topic}', topic);

  try {
    const raw = await callAI(t('prompt_system'), prompt, true);
    let data;
    try { data = JSON.parse(raw); }
    catch {
      const clean = raw.replace(/```json\s*/gi, '').replace(/```\s*/g, '').trim();
      try { data = JSON.parse(clean); }
      catch {
        const match = clean.match(/\{[\s\S]*\}/);
        if (match) data = JSON.parse(match[0]);
        else throw new Error('JSON inv√°lido na resposta da IA');
      }
    }

    const dev = {
      ref: (data.ref || '').toUpperCase(),
      verse: data.verse || '',
      app_god: data.app_god || '',
      app_job: data.app_job || '',
      app_family: data.app_family || '',
      core: data.core || '',
      topic,
      date: dateKey(state.currentDate),
      id: Date.now()
    };

    state.currentDevotional = dev;
    state.devotionals[dateKey(state.currentDate)] = dev;
    DB.save();
    renderDevotional(dev);
    showToast('‚ú¶ Devocional gerado!', 'success');

    // Save to cloud if logged in
    if (state.user) {
      await saveToCloud(dev);
      updateUserStats();
    }
  } catch(e) {
    showToast('‚ùå ' + e.message, 'error'); console.error(e);
  } finally {
    hideLoader();
    document.getElementById('generateBtn').disabled = false;
  }
}

/* ============================================================
   RENDER DEVOTIONAL
   ============================================================ */
function renderDevotional(dev) {
  document.getElementById('refDisplay').textContent = dev.ref;
  document.getElementById('verseDisplay').textContent = dev.verse;
  document.getElementById('appGod').textContent = dev.app_god;
  document.getElementById('appJob').textContent = dev.app_job;
  document.getElementById('appFamily').textContent = dev.app_family;
  document.getElementById('coreDisplay').textContent = `"${dev.core}"`;
  const labels = t('points_labels');
  document.getElementById('label1').textContent = labels[0];
  document.getElementById('label2').textContent = labels[1];
  document.getElementById('label3').textContent = labels[2];
  const card = document.getElementById('devotionalCard');
  card.style.animation = 'none';
  card.offsetHeight;
  card.style.animation = '';
  updateFavButton();
}

/* ============================================================
   FAVORITES
   ============================================================ */
function isFavorite(dev) {
  if (!dev) return false;
  return state.favorites.some(f => f.id === dev.id || f.ref === dev.ref);
}

async function toggleFavorite() {
  if (!state.currentDevotional) return;
  const dev = state.currentDevotional;
  const idx = state.favorites.findIndex(f => f.id === dev.id || f.ref === dev.ref);

  if (idx >= 0) {
    const cloudId = state.favorites[idx].cloudId;
    state.favorites.splice(idx, 1);
    showToast(t('unsaved'), 'info');
    if (state.user && cloudId) await removeFavFromCloud(cloudId);
  } else {
    const favItem = { ...dev };
    if (state.user) {
      const cloudId = await saveFavToCloud(dev);
      if (cloudId) favItem.cloudId = cloudId;
    }
    state.favorites.unshift(favItem);
    showToast(t('saved'), 'success');
  }

  DB.save();
  updateFavButton();
  updateFavBadge();
  if (state.user) updateUserStats();
}

function updateFavButton() {
  const btn = document.getElementById('favBtn');
  if (!btn) return;
  const fav = isFavorite(state.currentDevotional);
  btn.textContent = fav ? t('saved_btn') : t('save_btn');
  btn.classList.toggle('active', fav);
}

function updateFavBadge() {
  const badge = document.getElementById('favBadge');
  const count = state.favorites.length;
  badge.style.display = count > 0 ? 'flex' : 'none';
  badge.textContent = count > 9 ? '9+' : count;
  const favNavIcon = document.querySelector('#nav-favorites .nav-btn-icon');
  if (favNavIcon) favNavIcon.textContent = count > 0 ? 'üíõ' : 'ü§ç';
}

function renderFavorites() {
  const list = document.getElementById('favList');
  if (state.favorites.length === 0) {
    list.innerHTML = `<div class="empty-state">
      <div class="empty-icon">ü§ç</div>
      <div class="empty-title">${t('empty_fav_title')}</div>
      <div class="empty-desc">${t('empty_fav_desc')}</div>
      ${!state.user ? `<br><button onclick="openAuthModal()" style="background:var(--gold);color:white;border:none;padding:10px 20px;border-radius:8px;font-family:var(--font-ui);font-weight:700;cursor:pointer;">‚òÅÔ∏è Entre para sincronizar</button>` : ''}
    </div>`;
    return;
  }

  list.innerHTML = `
    ${!state.user ? `<div style="text-align:center;padding:12px;background:var(--gold-pale);border-radius:8px;margin-bottom:12px;font-size:0.82rem;color:var(--text-secondary);">‚òÅÔ∏è <a href="#" onclick="openAuthModal()" style="color:var(--gold);font-weight:700;">Entre</a> para salvar na nuvem</div>` : `<div style="text-align:center;padding:8px;font-size:0.72rem;color:#22c55e;">‚òÅÔ∏è Sincronizado com a nuvem</div>`}
    ${state.favorites.map((fav, i) => `
    <div class="fav-item" data-idx="${i}">
      <div class="fav-item-accent"></div>
      <div class="fav-item-content">
        <div class="fav-item-ref">${fav.ref}</div>
        <div class="fav-item-verse">"${fav.verse}"</div>
        <div class="fav-item-date">${formatDate(new Date(fav.date + 'T12:00:00'))} ¬∑ ${fav.topic || ''}</div>
      </div>
      <button class="fav-item-del" data-del="${i}" aria-label="Remover favorito">‚úï</button>
    </div>
  `).join('')}`;

  list.querySelectorAll('.fav-item').forEach(el => {
    el.addEventListener('click', (e) => {
      if (e.target.closest('[data-del]')) return;
      loadFavorite(+el.dataset.idx);
    });
  });

  list.querySelectorAll('[data-del]').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const idx = +btn.dataset.del;
      const cloudId = state.favorites[idx]?.cloudId;
      state.favorites.splice(idx, 1);
      if (state.user && cloudId) await removeFavFromCloud(cloudId);
      DB.save();
      renderFavorites();
      updateFavBadge();
      if (state.user) updateUserStats();
    });
  });
}

function loadFavorite(idx) {
  const dev = state.favorites[idx];
  if (!dev) return;
  state.currentDevotional = dev;
  renderDevotional(dev);
  showPage('home');
}

/* ============================================================
   DATE NAVIGATION
   ============================================================ */
function formatDate(d) {
  const opts = { day: 'numeric', month: 'long', year: 'numeric' };
  const loc = state.lang === 'pt-BR' ? 'pt-BR' : state.lang;
  return d.toLocaleDateString(loc, opts);
}

function updateDateDisplay() {
  const d = state.currentDate;
  const today = state.today;
  let label = '';
  if (sameDay(d, today)) label = t('today');
  else {
    const diff = Math.round((d - today) / 86400000);
    if (diff === -1) label = t('yesterday');
    else if (diff === 1) label = t('tomorrow');
    else {
      const opts = { weekday: 'long' };
      const loc = state.lang === 'pt-BR' ? 'pt-BR' : state.lang;
      label = d.toLocaleDateString(loc, opts);
    }
  }
  document.getElementById('dateLabelEl').textContent = label;
  document.getElementById('dateFullEl').textContent = formatDate(d);
  document.getElementById('nextDayBtn').disabled = sameDay(d, today) || d >= today;
}

function changeDate(delta) {
  const nd = new Date(state.currentDate);
  nd.setDate(nd.getDate() + delta);
  if (nd > state.today) return;
  state.currentDate = nd;
  updateDateDisplay();
  const dk = dateKey(nd);
  if (state.devotionals[dk]) {
    state.currentDevotional = state.devotionals[dk];
    renderDevotional(state.currentDevotional);
  } else {
    renderDevotional({ ref: '...', verse: t('generating') + '...', app_god: '', app_job: '', app_family: '', core: '', topic: '', date: dk, id: 0 });
  }
}

/* ============================================================
   SHARE
   ============================================================ */
function getShareText() {
  const dev = state.currentDevotional;
  if (!dev) return '';
  return t('share_text').replace('{ref}', dev.ref).replace('{verse}', dev.verse).replace('{core}', dev.core);
}

function openShareModal() {
  document.getElementById('shareModal').classList.add('active');
  document.getElementById('shareModalTitle').textContent = t('share_title');
  document.getElementById('shareCancelLabel').textContent = t('share_cancel');
  document.getElementById('shareCopyLabel').textContent = t('share_copy');
  document.getElementById('shareNativeLabel').textContent = t('share_more');
}

document.getElementById('shareWhatsApp').addEventListener('click', () => { window.open(`https://wa.me/?text=${encodeURIComponent(getShareText())}`, '_blank'); closeShareModal(); });
document.getElementById('shareTelegram').addEventListener('click', () => { window.open(`https://t.me/share/url?text=${encodeURIComponent(getShareText())}`, '_blank'); closeShareModal(); });
document.getElementById('shareTwitter').addEventListener('click', () => { window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(getShareText().substring(0, 250))}`, '_blank'); closeShareModal(); });
document.getElementById('shareFacebook').addEventListener('click', () => { window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}`, '_blank'); closeShareModal(); });
document.getElementById('shareInstagram').addEventListener('click', () => { navigator.clipboard.writeText(getShareText()).then(() => showToast('üìã Texto copiado! Cole no Instagram.', 'info')); closeShareModal(); });
document.getElementById('shareCopy').addEventListener('click', () => { navigator.clipboard.writeText(getShareText()).then(() => showToast(t('copied'), 'success')); closeShareModal(); });
document.getElementById('shareNative').addEventListener('click', () => { if (navigator.share) navigator.share({ title: 'Hoje na Palavra', text: getShareText() }).catch(() => {}); closeShareModal(); });
document.getElementById('shareModalClose').addEventListener('click', closeShareModal);
document.getElementById('shareModal').addEventListener('click', (e) => { if (e.target === document.getElementById('shareModal')) closeShareModal(); });

function closeShareModal() { document.getElementById('shareModal').classList.remove('active'); }

/* ============================================================
   DOWNLOAD
   ============================================================ */
async function downloadImage() {
  const dev = state.currentDevotional;
  if (!dev) return;
  const btn = document.getElementById('downloadBtn');
  btn.textContent = '‚è≥'; btn.disabled = true;

  try {
    const canvas = document.createElement('canvas');
    const W = 1080, H = 1920;
    canvas.width = W; canvas.height = H;
    const ctx = canvas.getContext('2d');

    const bgGrad = ctx.createLinearGradient(0, 0, W, H);
    bgGrad.addColorStop(0, '#FFFCF5'); bgGrad.addColorStop(1, '#F5EDD0');
    ctx.fillStyle = bgGrad; ctx.fillRect(0, 0, W, H);

    const hGrad = ctx.createLinearGradient(0, 0, W, 400);
    hGrad.addColorStop(0, '#B8860B'); hGrad.addColorStop(1, '#E8B020');
    ctx.fillStyle = hGrad;
    roundRect(ctx, 60, 60, W - 120, 400, 24); ctx.fill();

    ctx.fillStyle = 'rgba(255,255,255,0.7)'; ctx.font = `bold 36px sans-serif`; ctx.textAlign = 'center';
    ctx.fillText('HOJE NA PALAVRA', W / 2, 130);
    ctx.fillStyle = 'rgba(255,255,255,0.9)'; ctx.font = `bold 42px sans-serif`;
    ctx.fillText(dev.ref, W / 2, 200);
    ctx.fillStyle = 'white'; ctx.font = `italic bold 48px Georgia, serif`;
    wrapText(ctx, `"${dev.verse}"`, W / 2, 270, W - 200, 65);

    ctx.fillStyle = '#B8860B'; ctx.fillRect(W/2 - 40, 490, 80, 4);
    ctx.font = '40px serif'; ctx.fillText('‚ú¶', W / 2, 560);

    const pts = [{ label: t('points_labels')[0], text: dev.app_god }, { label: t('points_labels')[1], text: dev.app_job }, { label: t('points_labels')[2], text: dev.app_family }];
    let py = 620;
    pts.forEach(pt => {
      ctx.fillStyle = '#B8860B'; ctx.font = `bold 36px sans-serif`; ctx.textAlign = 'left';
      ctx.fillText(pt.label, 120, py); py += 54;
      ctx.fillStyle = '#5C4A3A'; ctx.font = `40px Georgia, serif`;
      py = wrapText(ctx, pt.text, 120, py, W - 240, 58) + 30;
    });

    ctx.fillStyle = 'rgba(184,134,11,0.1)'; ctx.strokeStyle = 'rgba(184,134,11,0.4)'; ctx.lineWidth = 3;
    roundRect(ctx, 60, 1600, W - 120, 240, 20); ctx.fill(); ctx.stroke();
    ctx.fillStyle = '#8B6914'; ctx.font = `italic bold 48px Georgia, serif`; ctx.textAlign = 'center';
    wrapText(ctx, `"${dev.core}"`, W / 2, 1660, W - 200, 65);

    ctx.fillStyle = 'rgba(184,134,11,0.5)'; ctx.font = `32px sans-serif`;
    ctx.fillText('Hoje na Palavra ¬∑ Reflex√µes Di√°rias', W / 2, 1860);

    const link = document.createElement('a');
    link.href = canvas.toDataURL('image/jpeg', 0.92);
    link.download = `devocional-${dateKey(state.currentDate)}.jpg`;
    link.click();
    showToast('üñº Imagem salva!', 'success');
  } catch(e) {
    console.error(e); showToast('Erro ao criar imagem', 'error');
  } finally {
    btn.textContent = t('download_btn'); btn.disabled = false;
  }
}

function roundRect(ctx, x, y, w, h, r) {
  ctx.beginPath(); ctx.moveTo(x + r, y); ctx.lineTo(x + w - r, y);
  ctx.arcTo(x + w, y, x + w, y + r, r); ctx.lineTo(x + w, y + h - r);
  ctx.arcTo(x + w, y + h, x + w - r, y + h, r); ctx.lineTo(x + r, y + h);
  ctx.arcTo(x, y + h, x, y + h - r, r); ctx.lineTo(x, y + r);
  ctx.arcTo(x, y, x + r, y, r); ctx.closePath();
}

function wrapText(ctx, text, x, y, maxW, lineH) {
  const words = text.split(' '); let line = '';
  words.forEach(w => {
    const test = line + w + ' ';
    if (ctx.measureText(test).width > maxW && line !== '') {
      ctx.fillText(line.trim(), x, y); line = w + ' '; y += lineH;
    } else line = test;
  });
  ctx.fillText(line.trim(), x, y); return y;
}

/* ============================================================
   NOTIFICATIONS
   ============================================================ */
async function toggleNotifications() {
  const toggle = document.getElementById('notifToggle');
  if (toggle.checked) {
    if ('Notification' in window) {
      const perm = await Notification.requestPermission();
      if (perm === 'granted') {
        state.notifEnabled = true;
        scheduleLocalNotification();
        showToast(t('notif_enabled'), 'success');
      } else {
        toggle.checked = false; state.notifEnabled = false;
        showToast(t('notif_denied'), 'error');
      }
    } else {
      toggle.checked = false; showToast('Notifica√ß√µes n√£o suportadas neste navegador', 'error');
    }
  } else {
    state.notifEnabled = false; showToast(t('notif_disabled'), 'info');
  }
  DB.save();
}

function scheduleLocalNotification() {
  const now = new Date(); const next8am = new Date(now);
  next8am.setHours(8, 0, 0, 0);
  if (next8am <= now) next8am.setDate(next8am.getDate() + 1);
  const ms = next8am - now;
  setTimeout(() => {
    if (state.notifEnabled && Notification.permission === 'granted') {
      new Notification('‚òÄÔ∏è Hoje na Palavra', { body: '‚ú¶ Sua reflex√£o di√°ria est√° pronta. Comece o dia com a Palavra!', icon: 'icons/icon-192.png', tag: 'daily-devotional' });
      scheduleLocalNotification();
    }
  }, ms);
}

/* ============================================================
   THEME
   ============================================================ */
function applyTheme(dark) {
  state.darkMode = dark;
  document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
  document.getElementById('themeToggleBtn').textContent = dark ? '‚òÄÔ∏è' : 'üåô';
  document.getElementById('darkModeToggle').checked = dark;
  document.getElementById('themeColor').content = dark ? '#0F0D09' : '#B8860B';
  DB.save();
}

/* ============================================================
   NAVIGATION
   ============================================================ */
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  const page = document.getElementById(`page-${name}`);
  const btn = document.getElementById(`nav-${name}`);
  if (page) page.classList.add('active');
  if (btn) btn.classList.add('active');
  if (name === 'favorites') renderFavorites();
}

/* ============================================================
   I18N
   ============================================================ */
function applyI18n() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.dataset.i18n; if (t(key)) el.textContent = t(key);
  });
  document.getElementById('topicInput').placeholder = t('topic_placeholder');
  document.getElementById('generateBtn').textContent = t('create_btn');
  document.getElementById('aiSuggestBtn').title = t('ai_suggest_title');
  document.getElementById('favBtn').textContent = isFavorite(state.currentDevotional) ? t('saved_btn') : t('save_btn');
  document.getElementById('shareBtn').textContent = t('share_btn');
  document.getElementById('downloadBtn').textContent = t('download_btn');
  document.getElementById('favPageTitle').textContent = t('fav_title');
  document.getElementById('favPageSubtitle').textContent = t('fav_subtitle');
  document.getElementById('settingsTitle').textContent = t('settings_title');
  document.getElementById('settingsSubtitle').textContent = t('settings_subtitle');
  document.getElementById('settingLangTitle').textContent = t('section_lang');
  document.getElementById('settingAITitle').textContent = t('section_ai');
  document.getElementById('settingNotifTitle').textContent = t('section_notif');
  document.getElementById('settingAppearTitle').textContent = t('section_appear');
  document.getElementById('settingLinksTitle').textContent = t('section_links');
  document.getElementById('notifDailyLabel').textContent = t('notif_daily');
  document.getElementById('notifDailyDesc').textContent = t('notif_daily_desc');
  document.getElementById('darkModeLabel').textContent = t('dark_mode');
  document.getElementById('darkModeDesc').textContent = t('dark_mode_desc');
  document.getElementById('webAppLabel').textContent = t('web_app');
  document.getElementById('clearDataLabel').textContent = t('clear_data');
  document.getElementById('clearDataDesc').textContent = t('clear_data_desc');
  const labels = t('points_labels');
  const l1 = document.getElementById('label1'); const l2 = document.getElementById('label2'); const l3 = document.getElementById('label3');
  if (l1) l1.textContent = labels[0]; if (l2) l2.textContent = labels[1]; if (l3) l3.textContent = labels[2];
  updateDateDisplay();
}

function setLanguage(lang) {
  state.lang = lang;
  document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.lang === lang));
  document.documentElement.lang = lang;
  applyI18n();
  DB.save();
}

/* ============================================================
   PWA
   ============================================================ */
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault(); deferredPrompt = e;
  document.getElementById('installBanner').classList.add('show');
});
document.getElementById('installAppBtn').addEventListener('click', async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    deferredPrompt = null;
    document.getElementById('installBanner').classList.remove('show');
    if (outcome === 'accepted') showToast('App instalado! üéâ', 'success');
  }
});
document.getElementById('dismissBannerBtn').addEventListener('click', () => document.getElementById('installBanner').classList.remove('show'));
window.addEventListener('appinstalled', () => { document.getElementById('installBanner').classList.remove('show'); showToast('App instalado com sucesso! üéâ', 'success'); });

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => navigator.serviceWorker.register('sw.js').catch(e => console.warn('SW:', e)));
}

/* ============================================================
   EVENT LISTENERS
   ============================================================ */
document.querySelectorAll('.nav-btn').forEach(btn => btn.addEventListener('click', () => showPage(btn.dataset.page)));
document.getElementById('generateBtn').addEventListener('click', () => { const topic = document.getElementById('topicInput').value.trim(); if (topic) generateDevotional(topic); });
document.getElementById('topicInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') { const topic = e.target.value.trim(); if (topic) generateDevotional(topic); } });
document.getElementById('aiSuggestBtn').addEventListener('click', suggestTopic);
document.getElementById('prevDayBtn').addEventListener('click', () => changeDate(-1));
document.getElementById('nextDayBtn').addEventListener('click', () => changeDate(1));
document.getElementById('dateCenterBtn').addEventListener('click', () => { state.currentDate = new Date(state.today); updateDateDisplay(); const dk = dateKey(state.currentDate); if (state.devotionals[dk]) { state.currentDevotional = state.devotionals[dk]; renderDevotional(state.currentDevotional); } });
document.getElementById('favBtn').addEventListener('click', toggleFavorite);
document.getElementById('shareBtn').addEventListener('click', openShareModal);
document.getElementById('downloadBtn').addEventListener('click', downloadImage);
document.getElementById('themeToggleBtn').addEventListener('click', () => applyTheme(!state.darkMode));
document.getElementById('darkModeToggle').addEventListener('change', (e) => applyTheme(e.target.checked));
document.getElementById('notifBtn').addEventListener('click', () => { document.getElementById('notifToggle').checked = !document.getElementById('notifToggle').checked; toggleNotifications(); showPage('settings'); });
document.getElementById('notifToggle').addEventListener('change', toggleNotifications);
document.querySelectorAll('.lang-btn').forEach(btn => btn.addEventListener('click', () => setLanguage(btn.dataset.lang)));
document.getElementById('apiKeyInput').addEventListener('input', (e) => { state.apiKey = e.target.value; DB.save(); });
document.getElementById('apiKeyToggle').addEventListener('click', () => { const inp = document.getElementById('apiKeyInput'); inp.type = inp.type === 'password' ? 'text' : 'password'; });
document.getElementById('modelSelect').addEventListener('change', (e) => { state.model = e.target.value; DB.save(); });
document.getElementById('openWebAppBtn').addEventListener('click', () => window.open('https://fabricdeapps.github.io/hoje-na-palavra/', '_blank'));
document.getElementById('clearDataBtn').addEventListener('click', () => { if (confirm(t('clear_confirm'))) { DB.clear(); renderFavorites(); updateFavBadge(); showToast(t('clear_done'), 'success'); if (state.user) updateUserStats(); } });

// Auth events
document.getElementById('authHeaderBtn').addEventListener('click', () => {
  if (state.user) { showPage('settings'); } else { openAuthModal(); }
});
document.getElementById('authModalClose').addEventListener('click', closeAuthModal);
document.getElementById('authModal').addEventListener('click', (e) => { if (e.target === document.getElementById('authModal')) closeAuthModal(); });
document.getElementById('tabLogin').addEventListener('click', () => { document.getElementById('tabLogin').classList.add('active'); document.getElementById('tabRegister').classList.remove('active'); document.getElementById('loginForm').style.display = 'block'; document.getElementById('registerForm').style.display = 'none'; clearAuthError(); });
document.getElementById('tabRegister').addEventListener('click', () => { document.getElementById('tabRegister').classList.add('active'); document.getElementById('tabLogin').classList.remove('active'); document.getElementById('registerForm').style.display = 'block'; document.getElementById('loginForm').style.display = 'none'; clearAuthError(); });
document.getElementById('loginBtn').addEventListener('click', doLogin);
document.getElementById('registerBtn').addEventListener('click', doRegister);
document.getElementById('logoutBtn').addEventListener('click', doLogout);

// Enter key on auth inputs
['loginEmail','loginPassword'].forEach(id => {
  document.getElementById(id).addEventListener('keydown', (e) => { if (e.key === 'Enter') doLogin(); });
});
['regName','regEmail','regPassword'].forEach(id => {
  document.getElementById(id).addEventListener('keydown', (e) => { if (e.key === 'Enter') doRegister(); });
});

/* ============================================================
   INIT
   ============================================================ */
async function init() {
  DB.load();
  applyTheme(state.darkMode);
  document.getElementById('apiKeyInput').value = state.apiKey;
  document.getElementById('modelSelect').value = state.model;
  document.getElementById('notifToggle').checked = state.notifEnabled;
  document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.lang === state.lang));
  document.documentElement.lang = state.lang;
  updateDateDisplay();

  const dk = dateKey(state.currentDate);
  if (state.devotionals[dk]) {
    state.currentDevotional = state.devotionals[dk];
    renderDevotional(state.currentDevotional);
  } else {
    applyI18n();
  }

  applyI18n();
  updateFavBadge();

  if (state.notifEnabled && Notification.permission === 'granted') scheduleLocalNotification();

  // Init Supabase Auth
  await initSupabaseAuth();

  console.log('üôè Hoje na Palavra v2.0 com Supabase carregado');
}

init();
</script>
</body>
</html>
